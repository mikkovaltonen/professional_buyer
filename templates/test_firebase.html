<!DOCTYPE html>
<html>
<head>
    <title>Firebase Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; }
        #output { white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Firebase Connection Test</h1>
    
    <div class="test">
        <h3>Configuration Test</h3>
        <button onclick="testConfig()">Test Config</button>
        <div id="config-result"></div>
    </div>

    <div class="test">
        <h3>Firestore Connection Test</h3>
        <button onclick="testFirestore()">Test Firestore</button>
        <div id="firestore-result"></div>
    </div>

    <div class="test">
        <h3>Write Test Document</h3>
        <button onclick="testWrite()">Write Test Doc</button>
        <div id="write-result"></div>
    </div>

    <div class="test">
        <h3>Read Test Document</h3>
        <button onclick="testRead()">Read Test Doc</button>
        <div id="read-result"></div>
    </div>

    <div class="test">
        <h3>Output Log</h3>
        <div id="output"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDqjfK6cHvPeh0JmFo2Wcrc_UP0z-QRNP4",
            authDomain: "professional-buyer-cdd53.firebaseapp.com",
            projectId: "professional-buyer-cdd53",
            storageBucket: "professional-buyer-cdd53.firebasestorage.app",
            messagingSenderId: "270284181423",
            appId: "1:270284181423:web:df5cc19a181de8d9b5e95a",
            measurementId: "G-4WWWC5G727"
        };

        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        let app, db, auth;

        // Test configuration
        window.testConfig = async function() {
            const result = document.getElementById('config-result');
            try {
                log('Testing Firebase configuration...');
                
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                log('✓ Firebase app initialized successfully');
                
                // Initialize Firestore
                db = getFirestore(app);
                log('✓ Firestore initialized successfully');
                
                // Initialize Auth
                auth = getAuth(app);
                log('✓ Auth initialized successfully');
                
                // Sign in anonymously and wait for auth state
                await signInAnonymously(auth);
                log('✓ Anonymous authentication successful');
                
                // Wait for auth state to be fully ready
                await new Promise((resolve) => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            log('✓ Auth state confirmed - User ID: ' + user.uid);
                            resolve(user);
                        }
                    });
                });
                
                result.innerHTML = '<span style="color: green;">✓ Configuration OK (with auth)</span>';
                result.className = 'success';
                
                // Make available globally for other tests
                window.db = db;
                window.app = app;
                window.auth = auth;
                
            } catch (error) {
                log('✗ Configuration failed: ' + error.message);
                result.innerHTML = '<span style="color: red;">✗ Configuration failed: ' + error.message + '</span>';
                result.className = 'error';
            }
        };

        // Test Firestore connection
        window.testFirestore = function() {
            const result = document.getElementById('firestore-result');
            
            if (!window.db) {
                result.innerHTML = '<span style="color: red;">✗ Run Configuration Test first</span>';
                result.className = 'error';
                return;
            }

            try {
                log('Testing Firestore connection...');
                
                // Try to get a reference to a collection
                const testCollection = collection(window.db, 'connection_test');
                log('✓ Collection reference created successfully');
                
                result.innerHTML = '<span style="color: green;">✓ Firestore connection OK</span>';
                result.className = 'success';
                
            } catch (error) {
                log('✗ Firestore connection failed: ' + error.message);
                result.innerHTML = '<span style="color: red;">✗ Connection failed: ' + error.message + '</span>';
                result.className = 'error';
            }
        };

        // Test writing a document
        window.testWrite = async function() {
            const result = document.getElementById('write-result');
            
            if (!window.db) {
                result.innerHTML = '<span style="color: red;">✗ Run Configuration Test first</span>';
                result.className = 'error';
                return;
            }

            try {
                log('Testing document write...');
                
                const testData = {
                    test: true,
                    timestamp: new Date(),
                    message: "Firebase test document"
                };

                // Write to test collection
                const docRef = await addDoc(collection(window.db, 'connection_test'), testData);
                log('✓ Document written successfully with ID: ' + docRef.id);
                
                result.innerHTML = '<span style="color: green;">✓ Write successful (ID: ' + docRef.id + ')</span>';
                result.className = 'success';
                
            } catch (error) {
                log('✗ Write failed: ' + error.message);
                result.innerHTML = '<span style="color: red;">✗ Write failed: ' + error.message + '</span>';
                result.className = 'error';
            }
        };

        // Test reading documents
        window.testRead = async function() {
            const result = document.getElementById('read-result');
            
            if (!window.db) {
                result.innerHTML = '<span style="color: red;">✗ Run Configuration Test first</span>';
                result.className = 'error';
                return;
            }

            try {
                log('Testing document read...');
                
                const querySnapshot = await getDocs(collection(window.db, 'connection_test'));
                log('✓ Read query executed successfully');
                
                let count = 0;
                querySnapshot.forEach((doc) => {
                    count++;
                    log(`Document ${doc.id}: ${JSON.stringify(doc.data())}`);
                });
                
                result.innerHTML = '<span style="color: green;">✓ Read successful (' + count + ' documents found)</span>';
                result.className = 'success';
                
            } catch (error) {
                log('✗ Read failed: ' + error.message);
                result.innerHTML = '<span style="color: red;">✗ Read failed: ' + error.message + '</span>';
                result.className = 'error';
            }
        };

        // Auto-run configuration test on load
        log('Firebase Test Script loaded');
        log('Click "Test Config" to start testing...');
        
    </script>
</body>
</html>